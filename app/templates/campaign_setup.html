{% extends "base.html" %}

{% block head_extra %}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="glass-panel animate-fade-in" style="padding: 2rem; max-width: 900px; margin: 0 auto;">
    <h1>Create Campaign</h1>

    <form id="campaign-form" method="POST" action="{{ url_for('create_campaign') }}" enctype="multipart/form-data">
        <!-- Step 1: List Upload -->
        <div style="margin-bottom: 3rem;">
            <h3 style="margin-bottom: 1rem; color: var(--primary);">1. Recipients</h3>

            <div id="drop-zone" class="upload-zone">
                <i class="fa-solid fa-cloud-arrow-up"
                    style="font-size: 2rem; margin-bottom: 1rem; color: var(--text-muted);"></i>
                <p>Drag & Drop your CSV/Excel file here</p>
                <p style="font-size: 0.8rem; color: var(--text-muted); margin: 0.5rem 0;">or</p>
                <button type="button" class="btn btn-secondary"
                    onclick="document.getElementById('file-input').click()">Browse Files</button>
                <input type="file" id="file-input" name="recipient_file" accept=".csv, .xlsx" style="display: none;"
                    onchange="handleFileSelect(this)">
                <p id="file-name" style="margin-top: 1rem; font-weight: 600; color: var(--primary);"></p>
            </div>

            <!-- Preview Table -->
            <div id="csv-preview" style="margin-top: 1rem; display: none;">
                <h4>Map Columns</h4>
                <p style="font-size: 0.9rem; color: var(--text-muted);">Select the column that contains email addresses:
                </p>
                <select name="email_column" id="email-column-select" style="margin-top: 0.5rem; max-width: 300px;"
                    required>
                    <!-- Populated by JS -->
                </select>
                <div style="overflow-x: auto; margin-top: 1rem; border: 1px solid var(--border); border-radius: 8px;">
                    <table id="preview-table" style="width: 100%; border-collapse: collapse; font-size: 0.8rem;">
                        <!-- Populated by JS -->
                    </table>
                </div>
            </div>
        </div>

        <!-- Step 2: Message Composition -->
        <div style="margin-bottom: 3rem;">
            <h3 style="margin-bottom: 1rem; color: var(--primary);">2. Message</h3>

            <div class="form-group">
                <label for="campaign_name">Campaign Name (Internal)</label>
                <input type="text" id="campaign_name" name="campaign_name" required
                    placeholder="e.g. December Newsletter">
            </div>

            <div class="form-group">
                <label for="subject">Subject Line</label>
                <input type="text" id="subject" name="subject" required placeholder="e.g. Special Offer Just for You!">
            </div>

            <div class="form-group">
                <label>Message Body</label>
                <div style="background: white; color: black; border-radius: 8px; overflow: hidden;">
                    <div id="editor" style="height: 300px;"></div>
                </div>
                <input type="hidden" name="body_content" id="body_content">
            </div>

            <div class="form-group">
                <button type="button" class="btn btn-secondary" style="font-size: 0.9rem;"
                    onclick="insertTrackingLink()">
                    <i class="fa-solid fa-link" style="margin-right: 0.5rem;"></i> Insert Verification Link Button
                </button>
                <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">
                    This inserts a button that will be tracked when clicked.
                </p>
            </div>
        </div>

        <!-- Actions -->
        <div
            style="display: flex; justify-content: flex-end; gap: 1rem; padding-top: 2rem; border-top: 1px solid var(--border);">
            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Cancel</a>
            <button type="submit" class="btn btn-primary" onclick="prepareForm()">Review Campaign</button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
    // Initialize Quill
    var quill = new Quill('#editor', {
        theme: 'snow',
        placeholder: 'Compose your message...',
        modules: {
            toolbar: [
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                [{ 'header': [1, 2, 3, false] }],
                ['link', 'clean']
            ]
        }
    });

    function insertTrackingLink() {
        const range = quill.getSelection(true);
        // Insert a button-like link
        quill.insertEmbed(range.index, 'html', '<a href="{{ tracking_link }}" style="display: inline-block; padding: 10px 20px; background-color: #6366f1; color: white; text-decoration: none; border-radius: 5px; font-weight: bold;">Verify Email</a>');
        // Note: Quill generic HTML embed might be tricky. A standardized text replacement is safer for v1.
        // Let's just insert text for now and handle it on backend or use a simple link.

        quill.insertText(range.index, ' [VERIFY_BUTTON] ', 'bold', true);
    }

    function prepareForm() {
        // Put HTML into hidden input
        document.querySelector('#body_content').value = quill.root.innerHTML;
    }
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
{% endblock %}